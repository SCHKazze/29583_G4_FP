// GRUPO 4 - Puerta automática de garaje (Lanford)
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <conio.h>
#include <windows.h>

#define ARCHIVO_LOG "registro_puerta.csv"
#define ARCHIVO_ESTADO "estado_puerta.txt"
#define MAX_NOMBRE 64

typedef enum { CERRADA = 0, ABIERTA = 1 } EstadoPuerta;


void limpiarBufferEntrada(void) {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

void leerLinea(char *dest, size_t tam) {
    if (fgets(dest, (int)tam, stdin)) {
        size_t n = strlen(dest);
        if (n > 0 && dest[n - 1] == '\n')
            dest[n - 1] = '\0';
    } else {
        if (tam > 0) dest[0] = '\0';
    }
}

void timestampISO(char *dest, size_t tam) {
    time_t t = time(NULL);
    struct tm *tmv = localtime(&t);
    strftime(dest, tam, "%Y-%m-%d %H:%M:%S", tmv);
}

/* ================= ARCHIVO CSV ================= */

void asegurarCabeceraLog(void) {
    FILE *f = fopen(ARCHIVO_LOG, "a+");
    if (!f) return;

    fseek(f, 0, SEEK_END);
    if (ftell(f) == 0) {
        fprintf(f, "fecha_hora,accion,persona,estado_final\n");
    }
    fclose(f);
}

void registrarAccion(const char *accion, const char *persona, const char *estadoFinal) {
    asegurarCabeceraLog();

    FILE *f = fopen(ARCHIVO_LOG, "a");
    if (!f) return;

    char fecha[32];
    timestampISO(fecha, sizeof(fecha));

    fprintf(f, "%s,%s,%s,%s\n", fecha, accion, persona, estadoFinal);
    fclose(f);
}

void limpiarRegistro(void) {
    printf("¿Seguro que desea borrar el registro? (s/n): ");
    char op = getchar();
    limpiarBufferEntrada();

    if (op == 's' || op == 'S') {
        FILE *f = fopen(ARCHIVO_LOG, "w");
        if (!f) {
            printf("No se pudo limpiar el registro.\n");
            return;
        }
        fprintf(f, "fecha_hora,accion,persona,estado_final\n");
        fclose(f);
        printf("Registro limpiado correctamente.\n");
    } else {
        printf("Operacion cancelada.\n");
    }
}


void guardarEstadoTXT(EstadoPuerta estado) {
    FILE *f = fopen(ARCHIVO_ESTADO, "w");
    if (!f) return;

    fprintf(f, "%d\n", estado);
    fclose(f);
}

EstadoPuerta cargarEstadoTXT(void) {
    FILE *f = fopen(ARCHIVO_ESTADO, "r");
    if (!f) return CERRADA;

    int valor;
    fscanf(f, "%d", &valor);
    fclose(f);

    return (valor == 1) ? ABIERTA : CERRADA;
}


void mostrarEstado(EstadoPuerta estado) {
    printf("Estado actual de la puerta: %s\n",
           (estado == ABIERTA) ? "ABIERTA" : "CERRADA");
}

void abrirPuerta(EstadoPuerta *estado, const char *persona) {
    if (*estado == ABIERTA) {
        printf("La puerta ya está ABIERTA.\n");
        registrarAccion("ABRIR (sin cambio)", persona, "ABIERTA");
        return;
    }

    *estado = ABIERTA;
    guardarEstadoTXT(*estado);
    registrarAccion("ABRIR", persona, "ABIERTA");
    printf("Puerta ABIERTA.\n");
}

void cerrarPuerta(EstadoPuerta *estado, const char *persona) {
    if (*estado == CERRADA) {
        printf("La puerta ya está CERRADA.\n");
        registrarAccion("CERRAR (sin cambio)", persona, "CERRADA");
        return;
    }

    *estado = CERRADA;
    guardarEstadoTXT(*estado);
    registrarAccion("CERRAR", persona, "CERRADA");
    printf("Puerta CERRADA.\n");
}


void mostrarRegistro(void) {
    FILE *f = fopen(ARCHIVO_LOG, "r");
    if (!f) {
        printf("No existe registro.\n");
        return;
    }

    char linea[256];
    int primera = 1;

    printf("\n=== REGISTRO DE OPERACIONES ===\n");

    while (fgets(linea, sizeof(linea), f)) {
        if (primera) {
            printf("FECHA/HORA             | ACCION             | PERSONA                | ESTADO\n");
            printf("-----------------------+--------------------+------------------------+--------\n");
            primera = 0;
            continue;
        }

        char fecha[64], accion[64], persona[64], estado[32];
        sscanf(linea, "%63[^,],%63[^,],%63[^,],%31[^\n]",
               fecha, accion, persona, estado);

        printf("%-23s | %-18s | %-22s | %-8s\n",
               fecha, accion, persona, estado);
    }

    fclose(f);
}


int main(void) {
    EstadoPuerta estado = cargarEstadoTXT();
    asegurarCabeceraLog();

    int opcion;
    char persona[MAX_NOMBRE];

    do {
        system("cls");
        printf("======= PUERTA AUTOMATICA LANFORD =======\n");
        mostrarEstado(estado);
        printf("\n1) Abrir puerta\n");
        printf("2) Cerrar puerta\n");
        printf("3) Mostrar registro\n");
        printf("4) Limpiar registro\n");
        printf("0) Salir\n");
        printf("Seleccione una opcion: ");

        if (scanf("%d", &opcion) != 1) {
            limpiarBufferEntrada();
            continue;
        }
        limpiarBufferEntrada();

        switch (opcion) {
            case 1:
                printf("Nombre de la persona: ");
                leerLinea(persona, sizeof(persona));
                if (strlen(persona) == 0) strcpy(persona, "SIN_NOMBRE");
                abrirPuerta(&estado, persona);
                break;

            case 2:
                printf("Nombre de la persona: ");
                leerLinea(persona, sizeof(persona));
                if (strlen(persona) == 0) strcpy(persona, "SIN_NOMBRE");
                cerrarPuerta(&estado, persona);
                break;

            case 3:
                mostrarRegistro();
                break;

            case 4:
                limpiarRegistro();
                break;

            case 0:
                printf("Saliendo del programa...\n");
                break;

            default:
                printf("Opcion invalida.\n");
        }

        printf("\nPresione una tecla para continuar...");
        getch();

    } while (opcion != 0);

    return 0;
}